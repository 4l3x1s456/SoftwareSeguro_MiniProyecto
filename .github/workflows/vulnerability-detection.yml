name: Vulnerability Detection Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas scikit-learn numpy
        # Instalar mlpack y armadillo para el modelo C++
        sudo apt-get update
        sudo apt-get install -y libmlpack-dev libarmadillo-dev
    
    - name: Extract code features
      run: |
        # Extraer caracterÃ­sticas del cÃ³digo fuente modificado
        python scripts/extract_features_from_diff.py
    
    - name: Run vulnerability detection
      run: |
        # Compilar y ejecutar el modelo de detecciÃ³n
        make -f Makefile.unix
        ./vulnerability_detector
    
    - name: Generate SHAP report
      run: |
        python scripts/generate_shap_report.py
    
    - name: Upload vulnerability report
      uses: actions/upload-artifact@v3
      with:
        name: vulnerability-report
        path: reports/
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'reports/vulnerability_summary.json';
          
          if (fs.existsSync(reportPath)) {
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            
            let comment = '## ğŸ” AnÃ¡lisis de Vulnerabilidades\n\n';
            
            if (report.high_risk_count > 0) {
              comment += `ğŸš¨ **${report.high_risk_count} vulnerabilidades crÃ­ticas detectadas**\n\n`;
              comment += '### Vulnerabilidades CrÃ­ticas:\n';
              report.high_risk_files.forEach(file => {
                comment += `- \`${file.path}\` - Probabilidad: ${(file.probability * 100).toFixed(1)}%\n`;
              });
            } else {
              comment += 'âœ… **No se detectaron vulnerabilidades crÃ­ticas**\n\n';
            }
            
            if (report.medium_risk_count > 0) {
              comment += `\nâš ï¸ **${report.medium_risk_count} posibles vulnerabilidades**\n`;
            }
            
            comment += `\nğŸ“Š **Resumen**: ${report.total_files} archivos analizados`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }